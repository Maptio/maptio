<ng-template #rt let-r="result" let-t="term">
	<img src="{{r.picture}}" class="rounded-circle authority" alt={{r.name}} /> {{r.name}}
</ng-template>
<ng-template #rtTag let-r="result" let-t="term">
	<span [style.color]="r.color">
		<i class="fa fa-tag mr-1" aria-hidden="true" [style.color]="r.color"></i>
		{{r.name}}</span>
</ng-template>

<form class="pt-2">
	<div class="card borderless mb-2 p-2">
		<fieldset name="initiativeName" *permissionsOnly="Permissions.canEditInitiativeName;initiative node; authorisedStrategy: enableFieldset; unauthorisedStrategy: disableFieldset; ">
			<div class="d-flex justify-content-start input-group">
				<input class="form-control borderless" id="inputName" type="text" name="inputName" [ngModelOptions]="{standalone: true}"
				 [ngModel]="node?.name" placeholder="Initiative name" (ngModelChange)="saveName($event)" rows="2" cols="" (blur)="onBlur()"
				/>
				<span class="input-group-addon icon-disabled text-muted transparent borderless" ngbTooltip="Only the {{authority}} of this initiative can edit it"
				 placement="top" container="body"></span>
			</div>
		</fieldset>
	</div>

	<div class="card borderless mb-2 p-2">
		<fieldset name="initiativeTags" *permissionsOnly="Permissions.canEditInitiativeTags;initiative node; authorisedStrategy: enableFieldset; unauthorisedStrategy: disableFieldset;">
			<div class="d-flex justify-content-start">
				<ul class="tags w-100 borderless-right pt-1">
					<li *ngFor="let tag of node?.tags; let i=index">
						<a class="btn btn-sm btn-secondary mr-1 tag btn-tag borderless active" [style.background-color]="tag.color" [style.color]="white">
							<i class="fa fa-tag mr-1" aria-hidden="true"></i>{{tag?.name}}
							<span class="remove transparent ml-1" (click)="removeTag(tag)"></span>
						</a>
					</li>
					<li>
						<input required="required" [resultTemplate]="rtTag" type="text" placeholder="Add tag" class="form-control form-control-sm col-8 p-1"
						 (selectItem)="saveTag($event)" [ngbTypeahead]="searchTag" editable="false" (focus)="$event.target.value='';focus$.next($event.target.value)"
						 (click)="$event.target.value=''; click$.next($event.target.value)" [resultFormatter]="tagFormatter" [inputFormatter]="tagFormatter"
						 #inputTag="ngbTypeahead" />
					</li>
				</ul>
				<span class="input-group-addon icon-disabled text-muted transparent borderless" ngbTooltip="Only the {{authority}} of this initiative can edit it"
				 placement="top" container="body"></span>
			</div>
		</fieldset>
	</div>


	<div class="card borderless mb-2 p-2">
		<fieldset name="initiativeAuthority" *permissionsOnly="Permissions.canEditInitiativeAuthority;initiative node; authorisedStrategy: enableFieldset; unauthorisedStrategy: disableFieldset; ">
			<div class="d-flex justify-content-start input-group">
				<div class="form-inline w-100">
					<label for="inputAccountable" class="form-control-label col-form-label text-muted mr-2">{{(team$ | async)?.settings.authority | titlecase }}

					</label>
					<div class="">
						<div class="input-group">
							<input #person required="required" [resultTemplate]="rt" type="text" id="inputAccountable" placeholder="Who's the {{(team$ | async)?.settings.authority | lowercase }} for this? Enter a team member"
							 [ngStyle]="{'background': ' url(' + node?.accountable?.picture + ') no-repeat'}" class="form-control background borderless-right"
							 [class.borderless-left]="node?.accountable?.picture" [ngModelOptions]="{standalone: true}" [ngModel]="node?.accountable"
							 (selectItem)="saveAccountable($event)" [ngbTypeahead]="searchTeamMember" [resultFormatter]="formatter" [inputFormatter]="formatter"
							 (blur)="onBlur()" />

							<span *permissionsOnly="Permissions.canEditInitiativeAuthority;initiative node" class="input-group-addon remove text-danger"
							 mwlConfirmationPopover title="Remove this authority and associated role?" placement="top" container="body" focusbutton="cancel"
							 appendToBody="false" (confirm)="removeAuthority()" (cancel)="cancelClicked=true"></span>
						</div>
					</div>
				</div>
				<span class="borderless transparent icon-disabled text-muted input-group-addon " ngbTooltip="Only the {{authority}} of this initiative can edit it"
				 placement="top" container="body"></span>
			</div>
		</fieldset>
	</div>

	<div class="card borderless mb-2 p-2">
		<fieldset name="initiativeDescription" *permissionsOnly="Permissions.canEditInitiativeDescription;initiative node; authorisedStrategy: enableFieldset; unauthorisedStrategy: disableFieldset; ">
			<div class="d-flex justify-content-start input-group">
				<div class="w-100 description overflow">
					<button *ngIf="descriptionHideMe" class="edit-description btn btn-link btn-sm col" (click)="descriptionHideMe=!descriptionHideMe">
						Edit
					</button>
					<textarea [hidden]="descriptionHideMe" #inputDescription class="w-100 form-control initiativeMarkdownDescription" id="inputDescription"
					 [ngModelOptions]="{standalone: true}" data-provide="markdown" data-iconlibrary="fa" data-autofocus="true" [ngModel]="node?.description || ''"
					 rows="5" placeholder='Describe the initiative in your own words and/or add a URL to your main resource' (ngModelChange)="saveDescription($event)"
					 (blur)="onBlur(); descriptionHideMe= !(node?.description === '') && !descriptionHideMe " (change)="saveDescription($event.target.value)">
														</textarea>
					<small [hidden]="descriptionHideMe" class="help-popup text-default text-muted">
						You can use
						<a href="https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet" target="_blank">markdown</a> to create links and add formatting
					</small>
					<div [hidden]="!descriptionHideMe">
						<markdown class="small mb-3" *ngIf="node?.description || ''" [data]="node?.description || ''"></markdown>
					</div>
				</div>
				<span class="input-group-addon icon-disabled text-muted borderless transparent" ngbTooltip="Only the {{authority}} of this initiative can edit it"
				 placement="top" container="body"></span>
			</div>
		</fieldset>
	</div>

	<div class="card borderless p-2 ">
		<div class="helpers overflow">
			<h6 class="card-subtitle mb-1 mt-1 text-muted">Whoâ€™s helping with this initiative?
			</h6>

			<div class="mb-2">
				<div *permissionsOnly="Permissions.canAddHelper;initiative node; then thenAddHelperBlock ; else elseAddHelperBlock "></div>
				<ng-template #thenAddHelperBlock>
					<input #person required="required" [resultTemplate]="rt" type="text" id="inputHelper" placeholder="Enter the name of a {{helper | lowercase}}"
					 class="form-control" (selectItem)="saveHelper($event)" (focus)="person.value=''" [ngbTypeahead]="searchTeamMember" [resultFormatter]="formatter"
					 [inputFormatter]="formatter" editable="false" />
				</ng-template>
				<ng-template #elseAddHelperBlock>
					<input #person required="required" [resultTemplate]="rt" type="text" id="inputHelper" placeholder="Enter the name of a {{helper | lowercase}}"
					 class="form-control" (selectItem)="saveHelperRestricted($event)" (focus)="person.value=''" [ngbTypeahead]="searchTeamMember"
					 [resultFormatter]="formatter" [inputFormatter]="formatter" editable="false" />
					<span class="text-info small" *ngIf="isRestrictedAddHelper">You can only add yourself as a {{helper}} in this initiative</span>
				</ng-template>
			</div>



			<div class="col-12">
				<div *ngIf="node?.accountable">
					<div class="row mb-0">
						<span class="ml-1 col">
							<img src="{{node?.accountable?.picture}}" width="16" class="rounded-circle" alt="{{node?.accountable?.name}}">
							<a routerLink="/map/{{datasetId}}/{{(dataset$ | async)?.initiative?.getSlug()}}/u/{{node?.accountable?.shortid}}/{{node?.accountable?.getSlug()}}">{{node?.accountable.name}}</a>
							<span class="text-muted small">({{(team$ | async)?.settings.authority | titlecase }})</span>
						</span>
						<button class="btn btn-link pull-right btn-sm" (click)="authorityHideMe=!authorityHideMe">Role
							<i class="fa" [class.fa-caret-up]="hideme[i]" [class.fa-caret-down]="!hideme[i]" aria-hidden="true"></i>
						</button>
					</div>
					<textarea [hidden]="!authorityHideMe" #inputAuthorityRole class="form-control form-control-sm unresizable mb-3" id="inputRole"
					 [ngModelOptions]="{standalone: true}" data-provide="markdown" data-iconlibrary="fa" data-autofocus="true" [ngModel]="node?.accountable?.roles[0]?.description || ''"
					 rows="3" placeholder="How is {{node?.accountable?.name}} helping?" (ngModelChange)="saveRole(node?.accountable,$event)"
					 (blur)="onBlur();authorityHideMe=!authorityHideMe" (change)="saveRole(node?.accountable,$event.target.value)"></textarea>

					<markdown class="small mb-3" [hidden]="authorityHideMe" *ngIf="node?.accountable?.roles[0]?.description" [data]="node?.accountable?.roles[0]?.description || ''"></markdown>

				</div>

				<div *ngFor="let user of node?.helpers; let i=index">
					<div class="row mb-0">
						<div *permissionsOnly="Permissions.canDeleteHelper;initiative node;helper user; then thenDeleteHelperBlock; else elseDeleteHelperBlock "></div>
						<ng-template #thenDeleteHelperBlock>
							<span class="remove text-danger mr-1 " placement="top" container="body" mwlConfirmationPopover title="Remove this helper and associated role?"
							 focusbutton="cancel" appendToBody="false" (confirm)="removeHelper(user)" (cancel)="cancelClicked = true"></span>
						</ng-template>
						<ng-template #elseDeleteHelperBlock>
							<span class="remove text-muted mr-1 " placement="top" container="body" ngbTooltip="Only the {{authority}} of this initiative can delete a {{helper}}"></span>
						</ng-template>

						<span class="pl-1 col">
							<img src="{{user.picture}}" width="16" class="rounded-circle" alt={{user.name}}>
							<a routerLink="/map/{{datasetId}}/{{(dataset$ | async)?.initiative?.getSlug()}}/u/{{user.shortid}}/{{user.getSlug()}}">{{user.name}}</a>

						</span>
						<button class="btn btn-link pull-right btn-sm" (click)="toggleRole(i)">Role
							<i class="fa" [class.fa-caret-up]="hideme[i]" [class.fa-caret-down]="!hideme[i]" aria-hidden="true"></i>
						</button>
					</div>
					<textarea [hidden]="!hideme[i]" #inputRole class="form-control form-control-sm unresizable mb-3 ml-1" id="inputRole" [ngModelOptions]="{standalone: true}"
					 data-provide="markdown" data-iconlibrary="fa" data-autofocus="true" [ngModel]="user.roles[0]?.description || ''" rows="3"
					 placeholder="How is {{user.name}} helping?" (ngModelChange)="saveRole(user,$event)" (blur)="onBlur();toggleRole(i)"
					 (change)="saveRole(user,$event.target.value)"></textarea>

					<markdown class="small mb-2" [hidden]="hideme[i]" *ngIf="user.roles[0]?.description" [data]="user.roles[0]?.description || ''"></markdown>
				</div>
				<small class="text-warning" *ngIf="node?.helpers.length === 0 || !(node?.helpers)">No helpers yet</small>

			</div>
		</div>
	</div>
</form>