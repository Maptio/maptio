<ng-template #rt let-r="result" let-t="term">
	<img src="{{r.picture}}" class="rounded-circle authority" /> {{r.name}}
</ng-template>
<ng-template #rtTag let-r="result" let-t="term">
	<span class="tag small checked" [style.background]="r.color">{{r.name}}</span>
</ng-template>

<form>
	<fieldset>
		<div class="mb-3">
			<div class="row">
				<div class="col-xl-12 mt-3">
					<!-- <h4 *ngIf="isReadOnly">{{node?.name}}</h4> -->
					<input type="text" class="form-control unresizable" id="inputName" type="text" name="inputName" [ngModelOptions]="{standalone: true}"
					 [ngModel]="node?.name" placeholder="Initiative name" (ngModelChange)="saveName($event)" rows="2" cols="" (blur)="onBlur()"
					/>
				</div>
			</div>
		</div>
		<div class="card mb-3">

			<div class="card-block">
				<ul class="tags">
					<li *ngFor="let tag of node?.tags; let i=index">
						<a class="tag small checked" [style.background]="tag?.color">{{tag?.name}}
							<span class="remove text-muted transparent" (click)="removeTag(tag)"></span>

						</a>
					</li>
					<li>
						<input #inputtag required="required" (focus)="inputtag.value=''" [resultTemplate]="rtTag" type="text" id="inputTag" placeholder="Add tag"
						 class="form-control form-control-sm" (selectItem)="saveTag($event)" [ngbTypeahead]="searchTag" editable="false" [resultFormatter]="tagFormatter"
						 [inputFormatter]="tagFormatter" />
					</li>
				</ul>

			</div>
		</div>


		<div class="card mb-3">

			<div class="card-block">

				<div class="row justify-content-between no-gutters">
					<label for="inputAccountable" class="form-control-label col-form-label text-muted">Authority
						<!-- <span class="help-popup" placement="top" container="body" ngbTooltip="The authority is the source of the initiative"></span> -->

					</label>

					<div class="ml-2 col">
						<div class="input-group">
							<!-- <span class="input-group-addon transparent" *ngIf="node?.accountable?.picture"><img class="rounded-circle authority" src="{{node?.accountable?.picture}}" /></span> -->
							<input #person required="required" [resultTemplate]="rt" type="text" id="inputAccountable" placeholder="Who's accountable for this? Enter a team member"
							 [ngStyle]="{'background': ' url(' + node?.accountable?.picture + ') no-repeat'}" class="form-control background borderless-right"
							 [class.borderless-left]="node?.accountable?.picture" [ngModelOptions]="{standalone: true}" [ngModel]="node?.accountable"
							 (selectItem)="saveAccountable($event)" [ngbTypeahead]="searchTeamMember" [resultFormatter]="formatter" [inputFormatter]="formatter"
							 (blur)="onBlur()" />

							<span class="input-group-addon remove text-danger" mwlConfirmationPopover title="Remove this authority and associated role?"
							 placement="top" container="body" focusbutton="cancel" appendToBody="false" (confirm)="removeAuthority()" (cancel)="cancelClicked=true"></span>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xl-12 mt-3">
						<button *ngIf="descriptionHideMe" class="edit-description btn btn-link btn-sm col" (click)="descriptionHideMe=!descriptionHideMe">
							Edit
						</button>
						<textarea [hidden]="descriptionHideMe" #inputDescription class="form-control initiativeMarkdownDescription" id="inputDescription"
						 [ngModelOptions]="{standalone: true}" data-provide="markdown" data-iconlibrary="fa" data-autofocus="true" [ngModel]="node?.description || ''"
						 rows="5" placeholder='Describe the initiative in your own words and/or add a URL to your main resource' (ngModelChange)="saveDescription($event)"
						 (blur)="onBlur(); descriptionHideMe= !(node?.description === '') && !descriptionHideMe " (change)="saveDescription($event.target.value)">
						</textarea>
						<small [hidden]="descriptionHideMe" class="help-popup text-default text-muted">
							You can use
							<a href="https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet" target="_blank">markdown</a> to create links and add formatting
						</small>
						<div [hidden]="!descriptionHideMe">
							<markdown class="small mb-3" *ngIf="node?.description || ''" [data]="node?.description || ''"></markdown>
						</div>

					</div>

				</div>
			</div>
		</div>

		<div class="card mb-3 overflow">
			<div class="card-block">
				<h6 class="card-subtitle mb-2 text-muted">Whoâ€™s helping with this initiative?
					<!-- <span class="help-popup" placement="top" container="body" ngbTooltip="A source is rarely able to fully manifest their initiative alone. They usually need help.
						
						Helpers bring specific ideas and carry out actions to realise the vision"></span> -->
				</h6>
				<div class="input-group mb-3">
					<input #person required="required" [resultTemplate]="rt" type="text" id="inputHelper" placeholder="Enter the name of a helper"
					 class="form-control" (selectItem)="saveHelper($event)" (focus)="person.value=''" [ngbTypeahead]="searchTeamMember" [resultFormatter]="formatter"
					 [inputFormatter]="formatter" editable="false" />
				</div>

				<div class="col-12">
					<div *ngIf="node?.accountable">
						<div class="row mb-0">
							<span class="ml-1 col">
								<img src="{{node?.accountable?.picture}}" width="16" class="rounded-circle">
								<a routerLink="/map/{{datasetId}}/{{(dataset$ | async)?.initiative?.getSlug()}}/u/{{node?.accountable?.shortid}}/{{node?.accountable?.getSlug()}}">{{node?.accountable.name}}</a>
								<span class="text-muted small">(Authority)</span>
							</span>
							<button class="btn btn-link pull-right btn-sm" (click)="authorityHideMe=!authorityHideMe">Role
								<i class="fa" [class.fa-caret-up]="hideme[i]" [class.fa-caret-down]="!hideme[i]" aria-hidden="true"></i>
							</button>
						</div>
						<textarea [hidden]="!authorityHideMe" #inputAuthorityRole class="form-control form-control-sm unresizable mb-3" id="inputRole"
						 [ngModelOptions]="{standalone: true}" data-provide="markdown" data-iconlibrary="fa" data-autofocus="true" [ngModel]="node?.accountable?.roles[0]?.description || ''"
						 rows="3" placeholder="How is {{node?.accountable?.name}} helping?" (ngModelChange)="saveRole(node?.accountable,$event)"
						 (blur)="onBlur();authorityHideMe=!authorityHideMe" (change)="saveRole(node?.accountable,$event.target.value)"></textarea>

						<markdown class="small mb-3" [hidden]="authorityHideMe" *ngIf="node?.accountable?.roles[0]?.description" [data]="node?.accountable?.roles[0]?.description || ''"></markdown>

					</div>

					<div *ngFor="let user of node?.helpers; let i=index">
						<div class="row mb-0">
							<span class="remove text-danger mr-1 " placement="top" container="body" mwlConfirmationPopover title="Remove this helper and associated role?"
							 focusbutton="cancel" appendToBody="false" (confirm)="removeHelper(user)" (cancel)="cancelClicked = true">

							</span>
							<span class="pl-1 col">
								<img src="{{user.picture}}" width="16" class="rounded-circle">
								<a routerLink="/map/{{datasetId}}/{{(dataset$ | async)?.initiative?.getSlug()}}/u/{{user.shortid}}/{{user.getSlug()}}">{{user.name}}</a>

							</span>
							<button class="btn btn-link pull-right btn-sm" (click)="toggleRole(i)">Role
								<i class="fa" [class.fa-caret-up]="hideme[i]" [class.fa-caret-down]="!hideme[i]" aria-hidden="true"></i>
							</button>
						</div>
						<textarea [hidden]="!hideme[i]" #inputRole class="form-control form-control-sm unresizable mb-3 ml-1" id="inputRole" [ngModelOptions]="{standalone: true}"
						 data-provide="markdown" data-iconlibrary="fa" data-autofocus="true" [ngModel]="user.roles[0]?.description || ''" rows="3"
						 placeholder="How is {{user.name}} helping?" (ngModelChange)="saveRole(user,$event)" (blur)="onBlur();toggleRole(i)"
						 (change)="saveRole(user,$event.target.value)"></textarea>

						<markdown class="small mb-2" [hidden]="hideme[i]" *ngIf="user.roles[0]?.description" [data]="user.roles[0]?.description || ''"></markdown>
					</div>
					<small class="text-warning" *ngIf="node?.helpers.length === 0 || !(node?.helpers)">No helpers yet</small>

				</div>
			</div>
		</div>
	</fieldset>
</form>